{% extends "base.html" %}

{% block title %}Leave Quotas - FlowDeck{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <h2>
        <i class="fas fa-calendar-check text-primary"></i> Employee Leave Quotas
      </h2>
      <p class="text-muted">Manage annual, sick, and personal leave quotas for employees</p>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Department</th>
              <th class="text-center">Annual Leave</th>
              <th class="text-center">Sick Leave</th>
              <th class="text-center">Personal Leave</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for data in user_leave_data %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  {% if data.user.profile_picture %}
                    <img src="{{ url_for('static', filename='uploads/profiles/' + data.user.profile_picture.split('/')[-1]) }}" 
                         alt="{{ data.user.name }}" 
                         class="rounded-circle me-2" 
                         style="width: 40px; height: 40px; object-fit: cover;">
                  {% else %}
                    <div class="avatar-circle me-2" style="background: linear-gradient(135deg, {{ ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'][data.user.id % 8] }} 0%, {{ ['#EE5A6F', '#3DB3AA', '#3AA3C1', '#FF8C69', '#7FC8B8', '#E5CA5F', '#A97FB4', '#6FA8C8'][data.user.id % 8] }} 100%);">
                      <span>{{ data.user.name[0].upper() }}</span>
                    </div>
                  {% endif %}
                  <div>
                    <div class="fw-bold">{{ data.user.name }}</div>
                    <small class="text-muted">{{ data.user.email }}</small>
                  </div>
                </div>
              </td>
              <td>
                {% if data.user.department %}
                  <span class="badge bg-info">{{ data.user.department.name }}</span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="quota-info">
                  <strong>{{ data.quotas.annual }}</strong> days
                  <br>
                  <small class="text-success">Used: {{ data.used.annual }}</small>
                  <br>
                  <small class="text-primary">Left: {{ data.remaining.annual }}</small>
                </div>
              </td>
              <td class="text-center">
                <div class="quota-info">
                  <strong>{{ data.quotas.sick }}</strong> days
                  <br>
                  <small class="text-success">Used: {{ data.used.sick }}</small>
                  <br>
                  <small class="text-primary">Left: {{ data.remaining.sick }}</small>
                </div>
              </td>
              <td class="text-center">
                <div class="quota-info">
                  <strong>{{ data.quotas.personal }}</strong> days
                  <br>
                  <small class="text-success">Used: {{ data.used.personal }}</small>
                  <br>
                  <small class="text-primary">Left: {{ data.remaining.personal }}</small>
                </div>
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-sm btn-primary" 
                        onclick="openEditModal({{ data.user.id }})">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Edit Quota Modals (moved outside table for proper rendering) -->
{% for data in user_leave_data %}
<div class="modal fade" id="editQuotaModal{{ data.user.id }}" tabindex="-1" aria-labelledby="editQuotaModalLabel{{ data.user.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editQuotaModalLabel{{ data.user.id }}">
          <i class="fas fa-calendar-check text-primary"></i> 
          Edit Leave Quota - {{ data.user.name }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('admin.edit_leave_quota', user_id=data.user.id) }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="annual_leave_quota{{ data.user.id }}" class="form-label">
              Annual Leave Quota (days)
            </label>
            <input type="number" 
                   class="form-control" 
                   id="annual_leave_quota{{ data.user.id }}" 
                   name="annual_leave_quota" 
                   value="{{ data.quotas.annual }}" 
                   min="0" 
                   required>
            <small class="text-muted">Used: {{ data.used.annual }} days</small>
          </div>

          <div class="mb-3">
            <label for="sick_leave_quota{{ data.user.id }}" class="form-label">
              Sick Leave Quota (days)
            </label>
            <input type="number" 
                   class="form-control" 
                   id="sick_leave_quota{{ data.user.id }}" 
                   name="sick_leave_quota" 
                   value="{{ data.quotas.sick }}" 
                   min="0" 
                   required>
            <small class="text-muted">Used: {{ data.used.sick }} days</small>
          </div>

          <div class="mb-3">
            <label for="personal_leave_quota{{ data.user.id }}" class="form-label">
              Personal Leave Quota (days)
            </label>
            <input type="number" 
                   class="form-control" 
                   id="personal_leave_quota{{ data.user.id }}" 
                   name="personal_leave_quota" 
                   value="{{ data.quotas.personal }}" 
                   min="0" 
                   required>
            <small class="text-muted">Used: {{ data.used.personal }} days</small>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Note:</strong> Changes will take effect immediately. 
            Make sure the quota is sufficient to cover already approved leaves.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<style>
.avatar-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 16px;
}

.quota-info {
  line-height: 1.4;
}
</style>

<script>
function openEditModal(userId) {
  const modalId = 'editQuotaModal' + userId;
  const modalElement = document.getElementById(modalId);
  
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
  } else {
    console.error('Modal not found:', modalId);
  }
}

// Alternative: Initialize all modals on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('Page loaded, Bootstrap version:', typeof bootstrap !== 'undefined' ? 'loaded' : 'not loaded');
  
  // Log all modal elements for debugging
  const modals = document.querySelectorAll('.modal');
  console.log('Found', modals.length, 'modals');
});
</script>
{% endblock %}
