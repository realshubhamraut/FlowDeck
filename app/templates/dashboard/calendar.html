{% extends "base.html" %}

{% block title %}Calendar - FlowDeck{% endblock %}

{% block favicon %}
<link rel="icon" type="image/svg+xml" href="{{ url_for('favicon.favicon_section', section='calendar') }}">
{% endblock %}

{% block extra_css %}
<style>
body {
    background: linear-gradient(135deg, #f0f4ff 0%, #fff5f7 50%, #f0fff4 100%);
    min-height: 100vh;
}

.card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    border-radius: 16px;
}

.card-header {
    background: linear-gradient(135deg, #fff3e0, #ffe0b2) !important;
    border-radius: 16px 16px 0 0 !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.5) !important;
}

/* Google Calendar-like styling */
#calendar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Toolbar styling */
.fc-toolbar {
    margin-bottom: 1.5em !important;
}

.fc-toolbar-title {
    color: #3c4043;
    font-weight: 400;
    font-size: 1.375rem;
}

.fc-button {
    background-color: transparent !important;
    border: 1px solid #dadce0 !important;
    color: #3c4043 !important;
    font-weight: 500 !important;
    text-transform: capitalize !important;
    padding: 6px 16px !important;
    border-radius: 4px !important;
    transition: all 0.2s !important;
}

.fc-button:hover {
    background-color: #f8f9fa !important;
    border-color: #dadce0 !important;
}

.fc-button-active {
    background-color: #1a73e8 !important;
    color: white !important;
    border-color: #1a73e8 !important;
}

.fc-button-primary:not(:disabled):active,
.fc-button-primary:not(:disabled).fc-button-active {
    background-color: #1a73e8 !important;
    border-color: #1a73e8 !important;
}

/* Day grid styling */
.fc-daygrid-day {
    transition: background-color 0.2s;
}

.fc-daygrid-day:hover {
    background-color: #f8f9fa;
}

.fc-daygrid-day-number {
    color: #3c4043;
    font-size: 0.875rem;
    padding: 8px;
}

.fc-day-today {
    background-color: #e8f0fe !important;
}

.fc-day-today .fc-daygrid-day-number {
    background-color: #1a73e8;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Time grid styling (day/week view) */
.fc-timegrid-slot {
    height: 48px !important;
}

.fc-timegrid-slot-label {
    color: #70757a;
    font-size: 0.75rem;
    border: none !important;
}

.fc-timegrid-axis {
    border: none !important;
}

.fc-timegrid-divider {
    display: none;
}

.fc-timegrid-col {
    border-right: 1px solid #e0e0e0 !important;
}

.fc-col-header-cell {
    border: none !important;
    padding: 16px 0 !important;
}

.fc-col-header-cell-cushion {
    color: #70757a;
    font-weight: 500;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Event styling */
.fc-event {
    border-radius: 4px !important;
    border: none !important;
    padding: 4px 8px !important;
    font-size: 0.75rem !important;
    font-weight: 500 !important;
    cursor: pointer !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
    transition: all 0.2s !important;
}

.fc-event:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.18) !important;
    transform: translateY(-1px);
}

.fc-event-title {
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
}

.fc-event-time {
    font-size: 0.6875rem;
    opacity: 0.9;
}

/* Day view time events */
.fc-timegrid-event {
    border-radius: 4px !important;
}

.fc-timegrid-event-harness {
    margin-right: 2px !important;
}

/* Background events (holidays) */
.fc-bg-event {
    opacity: 0.15 !important;
    border-radius: 0 !important;
}

.holiday-event {
    opacity: 0.2 !important;
}

/* Now indicator (current time line) */
.fc-timegrid-now-indicator-line {
    border-color: #ea4335 !important;
    border-width: 2px !important;
}

.fc-timegrid-now-indicator-arrow {
    border-color: #ea4335 !important;
}

/* List view styling */
.fc-list-event {
    cursor: pointer;
    transition: background-color 0.2s;
}

.fc-list-event:hover {
    background-color: #f8f9fa !important;
}

.fc-list-event-dot {
    border-radius: 50% !important;
}

/* Scrollbar styling */
.fc-scroller::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.fc-scroller::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.fc-scroller::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.fc-scroller::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

.form-check-input:checked {
    background-color: #1a73e8;
    border-color: #1a73e8;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .fc-toolbar {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .fc-toolbar-chunk {
        margin-bottom: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 mb-1"><i class="fas fa-calendar me-2"></i> Calendar</h1>
            <p class="text-muted">View your tasks, meetings, and holidays in calendar view</p>
        </div>
    </div>

    <!-- Calendar -->
    <div class="row">
        <div class="col-lg-9 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Filters</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="showTasks" checked>
                        <label class="form-check-label" for="showTasks">
                            Tasks
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="showHolidays" checked>
                        <label class="form-check-label" for="showHolidays">
                            Holidays
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="showLeaves" checked>
                        <label class="form-check-label" for="showLeaves">
                            Leave Requests
                        </label>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Upcoming Events</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="upcomingEvents">
                        <div class="list-group-item">
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0">Legend</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-danger me-2" style="width: 20px; height: 20px;"></span>
                        <small>Urgent Tasks</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2" style="width: 20px; height: 20px;"></span>
                        <small>High Priority</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-info me-2" style="width: 20px; height: 20px;"></span>
                        <small>Medium Priority</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-success me-2" style="width: 20px; height: 20px;"></span>
                        <small>Low Priority</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-secondary me-2" style="width: 20px; height: 20px;"></span>
                        <small>Holidays</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2" style="width: 20px; height: 20px;"></span>
                        <small>Leave Requests</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewEventBtn" class="btn btn-primary">View Details</a>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    let calendar;
    
    // Initialize calendar
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        // Time configuration
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        slotDuration: '00:30:00',
        scrollTime: '08:00:00',
        
        // Display configuration
        nowIndicator: true,
        eventDisplay: 'auto',
        displayEventTime: true,
        displayEventEnd: false,
        
        // Height configuration
        height: 'auto',
        contentHeight: 'auto',
        aspectRatio: 1.8,
        
        // Event styling
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            meridiem: 'short'
        },
        
        // Day view specific settings
        views: {
            timeGridDay: {
                titleFormat: { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' },
                slotLabelFormat: {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: 'short'
                }
            },
            timeGridWeek: {
                titleFormat: { year: 'numeric', month: 'short', day: 'numeric' },
                dayHeaderFormat: { weekday: 'short', day: 'numeric' }
            },
            dayGridMonth: {
                titleFormat: { year: 'numeric', month: 'long' }
            }
        },
        
        events: function(info, successCallback, failureCallback) {
            fetch('{{ url_for("dashboard.calendar_events") }}')
                .then(response => response.json())
                .then(data => {
                    const events = [];
                    
                    // Add tasks
                    if (document.getElementById('showTasks').checked) {
                        data.tasks.forEach(task => {
                            const priorityColors = {
                                'urgent': '#dc3545',
                                'high': '#fd7e14',
                                'medium': '#0dcaf0',
                                'low': '#198754'
                            };
                            
                            // Parse the due date
                            let taskDate = new Date(task.due_date);
                            
                            // Create event object
                            const event = {
                                id: 'task-' + task.id,
                                title: '📋 ' + task.title,
                                start: task.due_date,
                                backgroundColor: priorityColors[task.priority] || '#6c757d',
                                borderColor: priorityColors[task.priority] || '#6c757d',
                                textColor: '#ffffff',
                                allDay: false, // Make tasks time-based for better display in day/week view
                                extendedProps: {
                                    type: 'task',
                                    taskId: task.id,
                                    priority: task.priority,
                                    status: task.status,
                                    description: task.description
                                }
                            };
                            
                            // Add start date if available for better range display
                            if (task.start_date) {
                                event.start = task.start_date;
                                event.end = task.due_date;
                            }
                            
                            events.push(event);
                        });
                    }
                    
                    // Add holidays
                    if (document.getElementById('showHolidays').checked) {
                        data.holidays.forEach(holiday => {
                            events.push({
                                id: 'holiday-' + holiday.id,
                                title: '🎉 ' + holiday.name,
                                start: holiday.date,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                textColor: '#ffffff',
                                allDay: true,
                                display: 'background', // Show as background for all-day events
                                classNames: ['holiday-event'],
                                extendedProps: {
                                    type: 'holiday',
                                    description: holiday.description
                                }
                            });
                            
                            // Add a visible event on top of background
                            events.push({
                                id: 'holiday-label-' + holiday.id,
                                title: '🎉 ' + holiday.name,
                                start: holiday.date,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                textColor: '#ffffff',
                                allDay: true,
                                extendedProps: {
                                    type: 'holiday',
                                    description: holiday.description
                                }
                            });
                        });
                    }
                    
                    // Add leave requests
                    if (document.getElementById('showLeaves').checked) {
                        data.leaves.forEach(leave => {
                            if (leave.status === 'approved') {
                                events.push({
                                    id: 'leave-' + leave.id,
                                    title: '🏖️ ' + leave.type,
                                    start: leave.start_date,
                                    end: leave.end_date,
                                    backgroundColor: '#0d6efd',
                                    borderColor: '#0d6efd',
                                    textColor: '#ffffff',
                                    allDay: true,
                                    extendedProps: {
                                        type: 'leave',
                                        leaveId: leave.id,
                                        reason: leave.reason
                                    }
                                });
                            }
                        });
                    }
                    
                    successCallback(events);
                    updateUpcomingEvents(events);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            showEventModal(info.event);
        },
        dateClick: function(info) {
            // Optionally navigate to create task with selected date
            window.location.href = '{{ url_for("tasks.create_task") }}?date=' + info.dateStr;
        }
    });
    
    calendar.render();
    
    // Refresh calendar when filters change
    document.getElementById('showTasks').addEventListener('change', () => calendar.refetchEvents());
    document.getElementById('showHolidays').addEventListener('change', () => calendar.refetchEvents());
    document.getElementById('showLeaves').addEventListener('change', () => calendar.refetchEvents());
    
    // Show event modal
    function showEventModal(event) {
        const modalBody = document.getElementById('eventModalBody');
        const viewBtn = document.getElementById('viewEventBtn');
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        let content = `<h5>${event.title}</h5>`;
        content += `<p><strong>Date:</strong> ${event.start.toLocaleDateString()}</p>`;
        
        if (event.extendedProps.type === 'task') {
            content += `<p><strong>Priority:</strong> <span class="badge task-priority-${event.extendedProps.priority}">${event.extendedProps.priority}</span></p>`;
            content += `<p><strong>Status:</strong> <span class="badge task-status-${event.extendedProps.status}">${event.extendedProps.status.replace('_', ' ')}</span></p>`;
            viewBtn.href = '{{ url_for("tasks.view_task", task_id=0) }}'.replace('0', event.extendedProps.taskId);
            viewBtn.style.display = 'inline-block';
        } else if (event.extendedProps.type === 'holiday') {
            content += `<p>${event.extendedProps.description || 'Public holiday'}</p>`;
            viewBtn.style.display = 'none';
        } else if (event.extendedProps.type === 'leave') {
            content += `<p><strong>Reason:</strong> ${event.extendedProps.reason || 'N/A'}</p>`;
            viewBtn.href = '{{ url_for("user.leave_requests") }}';
            viewBtn.style.display = 'inline-block';
        }
        
        modalBody.innerHTML = content;
        eventModal.show();
    }
    
    // Update upcoming events sidebar
    function updateUpcomingEvents(events) {
        const upcomingList = document.getElementById('upcomingEvents');
        const now = new Date();
        
        // Filter and sort upcoming events
        const upcoming = events
            .filter(event => new Date(event.start) >= now)
            .sort((a, b) => new Date(a.start) - new Date(b.start))
            .slice(0, 5);
        
        if (upcoming.length === 0) {
            upcomingList.innerHTML = '<div class="list-group-item text-center text-muted">No upcoming events</div>';
            return;
        }
        
        let html = '';
        upcoming.forEach(event => {
            const date = new Date(event.start);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${event.title}</h6>
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt me-1"></i>${dateStr}
                            </small>
                        </div>
                        <span class="badge" style="background-color: ${event.backgroundColor};">${event.extendedProps.type}</span>
                    </div>
                </div>
            `;
        });
        
        upcomingList.innerHTML = html;
    }
});
</script>

<style>
#calendar {
    max-width: 100%;
    margin: 0 auto;
}

.fc-event {
    cursor: pointer;
}

.fc-daygrid-event {
    padding: 2px 4px;
}
</style>
{% endblock %}
