{% extends "base.html" %}

{% block title %}Calendar - FlowDeck{% endblock %}

{% block favicon %}
<link rel="icon" type="image/svg+xml" href="{{ url_for('favicon.favicon_section', section='calendar') }}">
{% endblock %}

{% block extra_css %}
<style>
/* Modern Background with Gradient */
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    position: relative;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.container-fluid {
    position: relative;
    z-index: 1;
}

/* Glass Morphism Cards */
.card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border-radius: 20px;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.card-header {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    border-radius: 20px 20px 0 0 !important;
    border: none !important;
    color: white !important;
    padding: 1.5rem !important;
}

/* Google Calendar-like styling */
#calendar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Toolbar styling */
.fc-toolbar {
    margin-bottom: 1.5em !important;
}

.fc-toolbar-title {
    color: #3c4043;
    font-weight: 400;
    font-size: 1.375rem;
}

.fc-button {
    background-color: transparent !important;
    border: 1px solid #dadce0 !important;
    color: #3c4043 !important;
    font-weight: 500 !important;
    text-transform: capitalize !important;
    padding: 6px 16px !important;
    border-radius: 4px !important;
    transition: all 0.2s !important;
}

.fc-button:hover {
    background-color: #f8f9fa !important;
    border-color: #dadce0 !important;
}

.fc-button-active {
    background-color: #1a73e8 !important;
    color: white !important;
    border-color: #1a73e8 !important;
}

.fc-button-primary:not(:disabled):active,
.fc-button-primary:not(:disabled).fc-button-active {
    background-color: #1a73e8 !important;
    border-color: #1a73e8 !important;
}

/* Day grid styling */
.fc-daygrid-day {
    transition: background-color 0.2s;
}

.fc-daygrid-day:hover {
    background-color: #f8f9fa;
}

.fc-daygrid-day-number {
    color: #3c4043;
    font-size: 0.875rem;
    padding: 8px;
}

.fc-day-today {
    background-color: #e8f0fe !important;
}

.fc-day-today .fc-daygrid-day-number {
    background-color: #1a73e8;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Time grid styling (day/week view) */
.fc-timegrid-slot {
    height: 48px !important;
}

.fc-timegrid-slot-label {
    color: #70757a;
    font-size: 0.75rem;
    border: none !important;
}

.fc-timegrid-axis {
    border: none !important;
}

.fc-timegrid-divider {
    display: none;
}

.fc-timegrid-col {
    border-right: 1px solid #e0e0e0 !important;
}

.fc-col-header-cell {
    border: none !important;
    padding: 16px 0 !important;
}

.fc-col-header-cell-cushion {
    color: #70757a;
    font-weight: 500;
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Event styling */
.fc-event {
    border-radius: 4px !important;
    border: none !important;
    padding: 4px 8px !important;
    font-size: 0.75rem !important;
    font-weight: 500 !important;
    cursor: pointer !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
    transition: all 0.2s !important;
}

.fc-event:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.18) !important;
    transform: translateY(-1px);
}

.fc-event-title {
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
}

.fc-event-time {
    font-size: 0.6875rem;
    opacity: 0.9;
}

/* Day view time events */
.fc-timegrid-event {
    border-radius: 4px !important;
}

.fc-timegrid-event-harness {
    margin-right: 2px !important;
}

/* Background events (holidays) */
.fc-bg-event {
    opacity: 0.15 !important;
    border-radius: 0 !important;
}

.holiday-event {
    opacity: 0.2 !important;
}

/* Now indicator (current time line) */
.fc-timegrid-now-indicator-line {
    border-color: #ea4335 !important;
    border-width: 2px !important;
}

.fc-timegrid-now-indicator-arrow {
    border-color: #ea4335 !important;
}

/* List view styling */
.fc-list-event {
    cursor: pointer;
    transition: background-color 0.2s;
}

.fc-list-event:hover {
    background-color: #f8f9fa !important;
}

.fc-list-event-dot {
    border-radius: 50% !important;
}

/* Scrollbar styling */
.fc-scroller::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.fc-scroller::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.fc-scroller::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.fc-scroller::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

.form-check-input:checked {
    background-color: #1a73e8;
    border-color: #1a73e8;
}

/* Stats Cards */
.stat-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Gradient Classes */
.gradient-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
.gradient-success { background: linear-gradient(135deg, #10b981, #059669); }
.gradient-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.gradient-info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.gradient-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }

/* Filter Dots */
.filter-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.filter-item {
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s;
}

.filter-item:hover {
    background: rgba(102, 126, 234, 0.05);
}

.form-check-input {
    border-color: #667eea;
    cursor: pointer;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

/* Upcoming Events List */
.upcoming-list {
    max-height: 300px;
    overflow-y: auto;
}

.upcoming-item {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border: 1px solid #e9ecef;
    transition: all 0.2s;
}

.upcoming-item:hover {
    background: linear-gradient(135deg, #e9ecef, #f8f9fa);
    border-color: #667eea;
    transform: translateX(3px);
}

.upcoming-date {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
}

.upcoming-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

/* Animations */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes float {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(-20px, -20px); }
}

.animate-slide-up {
    animation: slideUp 0.6s ease-out;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .fc-toolbar {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .fc-toolbar-chunk {
        margin-bottom: 10px;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 24px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Modern Header with Stats -->
    <div class="card mb-4 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="card-header text-white text-center position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 70%); animation: float 6s ease-in-out infinite;"></div>
            <div class="position-relative">
                <h2 class="mb-1 fw-bold"><i class="fas fa-calendar-alt me-2"></i>Calendar</h2>
                <p class="mb-0 opacity-90">Manage your tasks, meetings, and holidays</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3 col-6 mb-3 animate-slide-up" style="animation-delay: 0.2s;">
            <div class="stat-card">
                <div class="stat-icon gradient-primary text-white">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-value" id="totalTasks">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3 animate-slide-up" style="animation-delay: 0.3s;">
            <div class="stat-card">
                <div class="stat-icon gradient-success text-white">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-value" id="totalHolidays">0</div>
                <div class="stat-label">Holidays</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3 animate-slide-up" style="animation-delay: 0.4s;">
            <div class="stat-card">
                <div class="stat-icon gradient-warning text-white">
                    <i class="fas fa-umbrella-beach"></i>
                </div>
                <div class="stat-value" id="totalLeaves">0</div>
                <div class="stat-label">Leave Requests</div>
            </div>
        </div>
        <div class="col-md-3 col-6 mb-3 animate-slide-up" style="animation-delay: 0.5s;">
            <div class="stat-card">
                <div class="stat-icon gradient-info text-white">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value" id="upcomingCount">0</div>
                <div class="stat-label">Upcoming</div>
            </div>
        </div>
    </div>

    <!-- Calendar & Sidebar -->
    <div class="row">
        <div class="col-lg-9 mb-4 animate-slide-up" style="animation-delay: 0.6s;">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Modern Sidebar -->
        <div class="col-lg-3">
            <!-- Filters Card -->
            <div class="card border-0 shadow-sm mb-3 animate-slide-up" style="animation-delay: 0.7s;">
                <div class="card-body">
                    <h6 class="mb-3 d-flex align-items-center">
                        <i class="fas fa-filter gradient-primary text-white me-2" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px;"></i>
                        <span>Filters</span>
                    </h6>
                    <div class="filter-item mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showTasks" checked>
                            <label class="form-check-label d-flex align-items-center" for="showTasks">
                                <span class="filter-dot" style="background: linear-gradient(135deg, #667eea, #764ba2);"></span>
                                Tasks
                            </label>
                        </div>
                    </div>
                    <div class="filter-item mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showHolidays" checked>
                            <label class="form-check-label d-flex align-items-center" for="showHolidays">
                                <span class="filter-dot" style="background: linear-gradient(135deg, #10b981, #059669);"></span>
                                Holidays
                            </label>
                        </div>
                    </div>
                    <div class="filter-item mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showLeaves" checked>
                            <label class="form-check-label d-flex align-items-center" for="showLeaves">
                                <span class="filter-dot" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></span>
                                Leave Requests
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Events -->
            <div class="card border-0 shadow-sm mb-3 animate-slide-up" style="animation-delay: 0.8s;">
                <div class="card-body">
                    <h6 class="mb-3 d-flex align-items-center">
                        <i class="fas fa-bell gradient-warning text-white me-2" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px;"></i>
                        <span>Upcoming</span>
                    </h6>
                    <div id="upcomingEvents" class="upcoming-list">
                        <div class="text-center py-3 text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="card border-0 shadow-sm animate-slide-up" style="animation-delay: 0.9s;">
                <div class="card-body">
                    <h6 class="mb-3 d-flex align-items-center">
                        <i class="fas fa-info-circle gradient-info text-white me-2" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px;"></i>
                        <span>Legend</span>
                    </h6>
                    <h6 class="mb-0">Legend</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-danger me-2" style="width: 20px; height: 20px;"></span>
                        <small>Urgent Tasks</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2" style="width: 20px; height: 20px;"></span>
                        <small>High Priority</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-info me-2" style="width: 20px; height: 20px;"></span>
                        <small>Medium Priority</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-success me-2" style="width: 20px; height: 20px;"></span>
                        <small>Low Priority</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-secondary me-2" style="width: 20px; height: 20px;"></span>
                        <small>Holidays</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2" style="width: 20px; height: 20px;"></span>
                        <small>Leave Requests</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewEventBtn" class="btn btn-primary">View Details</a>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    let calendar;
    
    // Initialize calendar
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        // Time configuration
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        slotDuration: '00:30:00',
        scrollTime: '08:00:00',
        
        // Display configuration
        nowIndicator: true,
        eventDisplay: 'auto',
        displayEventTime: true,
        displayEventEnd: false,
        
        // Height configuration
        height: 'auto',
        contentHeight: 'auto',
        aspectRatio: 1.8,
        
        // Event styling
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            meridiem: 'short'
        },
        
        // Day view specific settings
        views: {
            timeGridDay: {
                titleFormat: { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' },
                slotLabelFormat: {
                    hour: 'numeric',
                    minute: '2-digit',
                    meridiem: 'short'
                }
            },
            timeGridWeek: {
                titleFormat: { year: 'numeric', month: 'short', day: 'numeric' },
                dayHeaderFormat: { weekday: 'short', day: 'numeric' }
            },
            dayGridMonth: {
                titleFormat: { year: 'numeric', month: 'long' }
            }
        },
        
        events: function(info, successCallback, failureCallback) {
            fetch('{{ url_for("dashboard.calendar_events") }}')
                .then(response => response.json())
                .then(data => {
                    const events = [];
                    
                    // Update stats
                    document.getElementById('totalTasks').textContent = data.tasks ? data.tasks.length : 0;
                    document.getElementById('totalHolidays').textContent = data.holidays ? data.holidays.length : 0;
                    document.getElementById('totalLeaves').textContent = data.leaves ? data.leaves.length : 0;
                    
                    // Calculate upcoming events (next 7 days)
                    const today = new Date();
                    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    let upcomingCount = 0;
                    let upcomingEvents = [];
                    
                    // Add tasks
                    if (document.getElementById('showTasks').checked) {
                        data.tasks.forEach(task => {
                            const priorityColors = {
                                'urgent': '#dc3545',
                                'high': '#fd7e14',
                                'medium': '#0dcaf0',
                                'low': '#198754'
                            };
                            
                            // Parse the due date
                            let taskDate = new Date(task.due_date);
                            
                            // Create event object
                            const event = {
                                id: 'task-' + task.id,
                                title: '📋 ' + task.title,
                                start: task.due_date,
                                backgroundColor: priorityColors[task.priority] || '#6c757d',
                                borderColor: priorityColors[task.priority] || '#6c757d',
                                textColor: '#ffffff',
                                allDay: false, // Make tasks time-based for better display in day/week view
                                extendedProps: {
                                    type: 'task',
                                    taskId: task.id,
                                    priority: task.priority,
                                    status: task.status,
                                    description: task.description
                                }
                            };
                            
                            // Add start date if available for better range display
                            if (task.start_date) {
                                event.start = task.start_date;
                                event.end = task.due_date;
                            }
                            
                            events.push(event);
                        });
                    }
                    
                    // Add holidays
                    if (document.getElementById('showHolidays').checked) {
                        data.holidays.forEach(holiday => {
                            events.push({
                                id: 'holiday-' + holiday.id,
                                title: '🎉 ' + holiday.name,
                                start: holiday.date,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                textColor: '#ffffff',
                                allDay: true,
                                display: 'background', // Show as background for all-day events
                                classNames: ['holiday-event'],
                                extendedProps: {
                                    type: 'holiday',
                                    description: holiday.description
                                }
                            });
                            
                            // Add a visible event on top of background
                            events.push({
                                id: 'holiday-label-' + holiday.id,
                                title: '🎉 ' + holiday.name,
                                start: holiday.date,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                textColor: '#ffffff',
                                allDay: true,
                                extendedProps: {
                                    type: 'holiday',
                                    description: holiday.description
                                }
                            });
                        });
                    }
                    
                    // Add leave requests
                    if (document.getElementById('showLeaves').checked) {
                        data.leaves.forEach(leave => {
                            if (leave.status === 'approved') {
                                events.push({
                                    id: 'leave-' + leave.id,
                                    title: '🏖️ ' + leave.type,
                                    start: leave.start_date,
                                    end: leave.end_date,
                                    backgroundColor: '#0d6efd',
                                    borderColor: '#0d6efd',
                                    textColor: '#ffffff',
                                    allDay: true,
                                    extendedProps: {
                                        type: 'leave',
                                        leaveId: leave.id,
                                        reason: leave.reason
                                    }
                                });
                            }
                        });
                    }
                    
                    successCallback(events);
                    updateUpcomingEvents(events);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            showEventModal(info.event);
        },
        dateClick: function(info) {
            // Optionally navigate to create task with selected date
            window.location.href = '{{ url_for("tasks.create_task") }}?date=' + info.dateStr;
        }
    });
    
    calendar.render();
    
    // Refresh calendar when filters change
    document.getElementById('showTasks').addEventListener('change', () => calendar.refetchEvents());
    document.getElementById('showHolidays').addEventListener('change', () => calendar.refetchEvents());
    document.getElementById('showLeaves').addEventListener('change', () => calendar.refetchEvents());
    
    // Show event modal
    function showEventModal(event) {
        const modalBody = document.getElementById('eventModalBody');
        const viewBtn = document.getElementById('viewEventBtn');
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        
        let content = `<h5>${event.title}</h5>`;
        content += `<p><strong>Date:</strong> ${event.start.toLocaleDateString()}</p>`;
        
        if (event.extendedProps.type === 'task') {
            content += `<p><strong>Priority:</strong> <span class="badge task-priority-${event.extendedProps.priority}">${event.extendedProps.priority}</span></p>`;
            content += `<p><strong>Status:</strong> <span class="badge task-status-${event.extendedProps.status}">${event.extendedProps.status.replace('_', ' ')}</span></p>`;
            viewBtn.href = '{{ url_for("tasks.view_task", task_id=0) }}'.replace('0', event.extendedProps.taskId);
            viewBtn.style.display = 'inline-block';
        } else if (event.extendedProps.type === 'holiday') {
            content += `<p>${event.extendedProps.description || 'Public holiday'}</p>`;
            viewBtn.style.display = 'none';
        } else if (event.extendedProps.type === 'leave') {
            content += `<p><strong>Reason:</strong> ${event.extendedProps.reason || 'N/A'}</p>`;
            viewBtn.href = '{{ url_for("user.leave_requests") }}';
            viewBtn.style.display = 'inline-block';
        }
        
        modalBody.innerHTML = content;
        eventModal.show();
    }
    
    // Update upcoming events sidebar
    function updateUpcomingEvents(events) {
        const upcomingList = document.getElementById('upcomingEvents');
        const now = new Date();
        
        // Filter and sort upcoming events
        const upcoming = events
            .filter(event => new Date(event.start) >= now)
            .sort((a, b) => new Date(a.start) - new Date(b.start))
            .slice(0, 5);
        
        // Update upcoming count
        document.getElementById('upcomingCount').textContent = upcoming.length;
        
        if (upcoming.length === 0) {
            upcomingList.innerHTML = '<div class="text-center py-3 text-muted"><i class="fas fa-calendar-check fa-2x mb-2 d-block opacity-25"></i>No upcoming events</div>';
            return;
        }
        
        let html = '';
        upcoming.forEach(event => {
            const date = new Date(event.start);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Remove emoji from title for cleaner display
            const cleanTitle = event.title.replace(/[📋🎉🏖️]/g, '').trim();
            
            html += `
                <div class="upcoming-item">
                    <div class="upcoming-date text-muted">${dateStr} ${!event.allDay ? '• ' + timeStr : ''}</div>
                    <div class="upcoming-title">${cleanTitle}</div>
                        <div>
                            <h6 class="mb-1">${event.title}</h6>
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt me-1"></i>${dateStr}
                            </small>
                        </div>
                        <span class="badge" style="background-color: ${event.backgroundColor};">${event.extendedProps.type}</span>
                    </div>
                </div>
            `;
        });
        
        upcomingList.innerHTML = html;
    }
});
</script>

<style>
#calendar {
    max-width: 100%;
    margin: 0 auto;
}

.fc-event {
    cursor: pointer;
}

.fc-daygrid-event {
    padding: 2px 4px;
}
</style>
{% endblock %}
